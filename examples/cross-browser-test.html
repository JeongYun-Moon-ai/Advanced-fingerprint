<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Fingerprint v3 - Cross Browser Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #eee;
            padding: 1rem;
        }
        .container { max-width: 600px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 1.3rem;
            color: #00d9ff;
            margin-bottom: 0.3rem;
        }
        .subtitle {
            text-align: center;
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
        }
        .card h2 {
            color: #00d9ff;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #000;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hash-box {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }
        .hash-label {
            color: #888;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .hash-value {
            color: #00ff88;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.75rem;
            word-break: break-all;
            line-height: 1.4;
        }
        .accuracy-badge {
            display: inline-block;
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 1rem 0;
        }
        .signals {
            margin-top: 1rem;
            font-size: 0.75rem;
        }
        .signals table {
            width: 100%;
            border-collapse: collapse;
        }
        .signals td {
            padding: 0.5rem 0.3rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .signals td:first-child {
            color: #888;
            width: 40%;
        }
        .signals td:last-child {
            color: #ddd;
            font-family: monospace;
            font-size: 0.7rem;
            word-break: break-all;
        }
        .signals .version-tag {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.55rem;
            margin-left: 4px;
            font-weight: 600;
        }
        .signals .tag-v1 { background: rgba(63,185,80,0.2); color: #3fb950; }
        .signals .tag-v2 { background: rgba(88,166,255,0.2); color: #58a6ff; }
        .signals .tag-v3 { background: rgba(240,136,62,0.2); color: #f0883e; }
        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }
        .loading.active { display: block; }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #00d9ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .compare-section {
            background: rgba(255,200,0,0.1);
            border: 1px solid rgba(255,200,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .compare-section h3 {
            color: #ffc800;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .compare-section input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 0.8rem;
            color: #fff;
            font-family: monospace;
            font-size: 0.75rem;
        }
        .compare-section input:focus {
            outline: none;
            border-color: #ffc800;
        }
        .compare-result {
            margin-top: 0.8rem;
            padding: 0.8rem;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        .compare-result.match {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }
        .compare-result.mismatch {
            background: rgba(255,80,80,0.2);
            color: #ff5050;
        }
        .info-box {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.3);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            color: #aaa;
            line-height: 1.5;
        }
        .info-box strong { color: #00d9ff; }
        .copy-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .copy-btn:active { background: rgba(255,255,255,0.2); }
        .prev-hash {
            color: #f0883e;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Device Fingerprint v3</h1>
        <p class="subtitle">Hardware-based device identification (max 97% accuracy)</p>

        <div class="card">
            <div class="info-box">
                <strong>Test Method:</strong><br>
                1. Generate fingerprint here<br>
                2. Open same URL in Incognito/Private mode<br>
                3. Generate again - hash should be <strong>identical</strong><br>
                4. v3 signals also distinguish <strong>same-model devices</strong>
            </div>
        </div>

        <div class="card">
            <h2>Generate Fingerprint</h2>
            <button class="btn" id="generateBtn">Generate v3 Fingerprint</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Collecting 28 hardware signals...</p>
            </div>

            <div id="result" style="display:none;">
                <div style="text-align:center;">
                    <div class="accuracy-badge" id="accuracyValue">0%</div>
                    <div style="color:#888;font-size:0.75rem;">Estimated Accuracy (max 97%)</div>
                </div>

                <div class="hash-box">
                    <div class="hash-label">Device Hash</div>
                    <div class="hash-value" id="hashValue">-</div>
                    <button class="copy-btn" id="copyBtn">Copy Hash</button>
                    <div class="prev-hash" id="prevHash"></div>
                </div>
            </div>
        </div>

        <div class="card" id="signalsCard" style="display:none;">
            <h2>Hardware Signals (28 fields)</h2>
            <div class="signals">
                <table id="signalsTable"></table>
            </div>
        </div>

        <div class="card">
            <div class="compare-section">
                <h3>Compare Hash</h3>
                <p style="font-size:0.7rem;color:#888;margin-bottom:0.5rem;">
                    Paste hash from another browser/mode to compare:
                </p>
                <input type="text" id="compareInput" placeholder="Paste hash here...">
                <div id="compareResult" class="compare-result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script src="../packages/web/dist/index.umd.min.js"></script>
    <script>
        const SDK = window.AdvancedFingerprinting;

        // v3 Accuracy Weights
        const ACCURACY_WEIGHTS = {
            BASE: 0.02,
            GPU_RENDERER: 0.10, GPU_VENDOR: 0.02,
            SCREEN_RESOLUTION: 0.05, TIMEZONE: 0.03,
            HARDWARE_CONCURRENCY: 0.03, SHADER_PRECISION: 0.05,
            WEBGL_MAX_TEXTURE: 0.03, PLATFORM: 0.02,
            MATH_ENGINE: 0.05, WEBGL_RENDER: 0.04,
            FONT_FINGERPRINT: 0.05, CSS_FEATURES: 0.03,
            INTL_API: 0.03, AUDIO_STACK: 0.03,
            WEBGL2_PARAMS: 0.03, MEDIA_CAPABILITIES: 0.02,
            GPU_SILICON: 0.12, AUDIO_HARDWARE: 0.10,
            CANVAS_MICRO: 0.08, STORAGE_PROFILE: 0.04,
            MAX_ACCURACY: 0.97,
        };

        let currentHash = '';

        document.getElementById('generateBtn').onclick = async () => {
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').style.display = 'none';
            document.getElementById('signalsCard').style.display = 'none';

            try {
                let result;

                if (SDK && SDK.getFingerprint) {
                    result = await SDK.getFingerprint({ debug: true });
                } else {
                    // Fallback: basic fingerprinting
                    result = await fallbackGenerate();
                }

                document.getElementById('hashValue').textContent = result.hash;
                document.getElementById('accuracyValue').textContent = (result.accuracy * 100).toFixed(0) + '%';
                currentHash = result.hash;

                // Previous hash from persistence
                if (result.previousHash) {
                    document.getElementById('prevHash').textContent = 'Previous: ' + result.previousHash.substring(0, 16) + '...';
                }

                // Signals table
                const table = document.getElementById('signalsTable');
                table.innerHTML = '';
                const s = result.signals || {};

                const rows = [
                    // v1
                    ['GPU Renderer', s.gpuRenderer || '(N/A)', 'v1'],
                    ['GPU Vendor', s.gpuVendor || '(N/A)', 'v1'],
                    ['Screen', s.screenResolution || '', 'v1'],
                    ['Pixel Ratio', s.pixelRatio || '', 'v1'],
                    ['Timezone', s.timezone || '', 'v1'],
                    ['CPU Cores', s.hardwareConcurrency || '', 'v1'],
                    ['Platform', s.platform || '', 'v1'],
                    ['Max Texture', s.webglMaxTextureSize || '', 'v1'],
                    // v2
                    ['Math Engine', truncHash(s.mathEngineHash), 'v2'],
                    ['Font Hash', truncHash(s.fontHash), 'v2'],
                    ['WebGL Render', truncHash(s.webglRenderHash), 'v2'],
                    ['CSS Features', truncHash(s.cssFeatureHash), 'v2'],
                    ['Intl API', truncHash(s.intlHash), 'v2'],
                    ['Audio Stack', truncHash(s.audioStackHash), 'v2'],
                    ['WebGL2 Params', truncHash(s.webgl2Hash), 'v2'],
                    ['Media Caps', truncHash(s.mediaCapHash), 'v2'],
                    // v3
                    ['GPU Silicon', truncHash(s.gpuSiliconHash), 'v3'],
                    ['Audio DAC', truncHash(s.audioHardwareHash), 'v3'],
                    ['Canvas Micro', truncHash(s.canvasMicroHash), 'v3'],
                    ['Storage Profile', truncHash(s.storageProfileHash), 'v3'],
                ];

                for (const [label, value, ver] of rows) {
                    const tr = document.createElement('tr');
                    const tagClass = ver === 'v1' ? 'tag-v1' : ver === 'v2' ? 'tag-v2' : 'tag-v3';
                    tr.innerHTML = '<td>' + label + ' <span class="version-tag ' + tagClass + '">' + ver + '</span></td><td>' + value + '</td>';
                    table.appendChild(tr);
                }

                document.getElementById('result').style.display = 'block';
                document.getElementById('signalsCard').style.display = 'block';
            } catch (e) {
                alert('Error: ' + e.message);
            }

            document.getElementById('loading').classList.remove('active');
            document.getElementById('generateBtn').disabled = false;
        };

        function truncHash(hash) {
            if (!hash) return '(N/A)';
            return hash.substring(0, 16) + '...';
        }

        async function fallbackGenerate() {
            // Basic fallback if SDK not loaded
            const sha256 = async (data) => {
                const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(data));
                return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            };

            const c = document.createElement('canvas');
            const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
            const d = gl ? gl.getExtension('WEBGL_debug_renderer_info') : null;
            const renderer = d ? gl.getParameter(d.UNMASKED_RENDERER_WEBGL) : (gl ? gl.getParameter(gl.RENDERER) : '');
            const vendor = d ? gl.getParameter(d.UNMASKED_VENDOR_WEBGL) : (gl ? gl.getParameter(gl.VENDOR) : '');

            const signals = {
                gpuRenderer: renderer,
                gpuVendor: vendor,
                screenResolution: screen.width + 'x' + screen.height,
                pixelRatio: Math.round(window.devicePixelRatio * 100) / 100,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                hardwareConcurrency: navigator.hardwareConcurrency || 0,
                platform: navigator.platform || '',
                webglMaxTextureSize: gl ? gl.getParameter(gl.MAX_TEXTURE_SIZE) : 0,
            };

            const stableData = Object.values(signals).join('|');
            const hash = await sha256(stableData);

            let accuracy = ACCURACY_WEIGHTS.BASE;
            if (signals.gpuRenderer) accuracy += ACCURACY_WEIGHTS.GPU_RENDERER;
            if (signals.gpuVendor) accuracy += ACCURACY_WEIGHTS.GPU_VENDOR;
            if (signals.screenResolution !== '0x0') accuracy += ACCURACY_WEIGHTS.SCREEN_RESOLUTION;
            if (signals.timezone) accuracy += ACCURACY_WEIGHTS.TIMEZONE;
            if (signals.hardwareConcurrency > 0) accuracy += ACCURACY_WEIGHTS.HARDWARE_CONCURRENCY;
            if (signals.platform) accuracy += ACCURACY_WEIGHTS.PLATFORM;
            if (signals.webglMaxTextureSize > 0) accuracy += ACCURACY_WEIGHTS.WEBGL_MAX_TEXTURE;
            accuracy = Math.min(accuracy, ACCURACY_WEIGHTS.MAX_ACCURACY);

            return { hash, accuracy, signals };
        }

        // Copy button
        document.getElementById('copyBtn').onclick = () => {
            navigator.clipboard.writeText(currentHash).then(() => {
                document.getElementById('copyBtn').textContent = 'Copied!';
                setTimeout(() => {
                    document.getElementById('copyBtn').textContent = 'Copy Hash';
                }, 2000);
            });
        };

        // Compare input
        document.getElementById('compareInput').addEventListener('input', (e) => {
            const inputHash = e.target.value.trim();
            const resultEl = document.getElementById('compareResult');

            if (!inputHash || !currentHash) {
                resultEl.style.display = 'none';
                return;
            }

            resultEl.style.display = 'block';
            if (inputHash === currentHash) {
                resultEl.className = 'compare-result match';
                resultEl.textContent = 'MATCH - Same device!';
            } else {
                resultEl.className = 'compare-result mismatch';
                resultEl.textContent = 'MISMATCH - Different device or error';
            }
        });
    </script>
</body>
</html>
