<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fingerprinting - 95% Accuracy Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            min-height: 100vh;
            color: #c9d1d9;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #58a6ff, #3fb950, #f0883e);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            text-align: center;
            color: #8b949e;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1rem;
        }

        .card {
            background: rgba(22, 27, 34, 0.9);
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 1rem;
        }

        .card h2 {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: #58a6ff;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .implemented {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
        }

        .new {
            background: rgba(240, 136, 62, 0.2);
            color: #f0883e;
        }

        .tech-list {
            list-style: none;
            font-size: 0.75rem;
        }

        .tech-list li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
        }

        .tech-list li:last-child {
            border-bottom: none;
        }

        .layer-title {
            color: #f0883e;
            font-weight: 600;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.7rem;
        }

        .btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .btn:hover {
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #30363d;
        }

        .btn.orange {
            background: linear-gradient(135deg, #f0883e, #d29922);
        }

        .result {
            display: none;
            margin-top: 0.75rem;
        }

        .result.active {
            display: block;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
            font-size: 0.75rem;
        }

        .result-item {
            background: #0d1117;
            padding: 0.4rem;
            border-radius: 4px;
        }

        .result-label {
            color: #8b949e;
            font-size: 0.65rem;
        }

        .result-value {
            color: #3fb950;
            font-family: monospace;
            word-break: break-all;
            font-size: 0.7rem;
        }

        .hash-display {
            background: #0d1117;
            padding: 0.5rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.65rem;
            color: #58a6ff;
            word-break: break-all;
        }

        .meter {
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            margin-top: 0.2rem;
        }

        .meter-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .meter-fill.green {
            background: linear-gradient(90deg, #238636, #3fb950);
        }

        .meter-fill.orange {
            background: linear-gradient(90deg, #d29922, #f0883e);
        }

        .accuracy-display {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(63, 185, 80, 0.1), rgba(88, 166, 255, 0.1));
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .accuracy-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3fb950;
        }

        .accuracy-label {
            font-size: 0.75rem;
            color: #8b949e;
        }

        textarea {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 0.5rem;
            color: #c9d1d9;
            font-family: monospace;
            resize: none;
            height: 60px;
            font-size: 0.8rem;
        }

        textarea:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .loading {
            text-align: center;
            padding: 1rem;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #21262d;
            border-top: 3px solid #58a6ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .module-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.6rem;
            background: #21262d;
            color: #8b949e;
        }

        .module-tag.active {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
        }

        .warning-box {
            background: rgba(210, 153, 34, 0.1);
            border: 1px solid rgba(210, 153, 34, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” Advanced Fingerprinting</h1>
        <p class="subtitle">95% ì •í™•ë„ - 4ê³„ì¸µ ì—”íŠ¸ë¡œí”¼ ìœµí•© (18ê°œ ëª¨ë“ˆ)</p>

        <div class="grid">
            <!-- êµ¬í˜„ í˜„í™© -->
            <div class="card">
                <h2>ğŸ“‹ ëª¨ë“ˆ í˜„í™© (18ê°œ)</h2>

                <div class="layer-title">ğŸ”§ Physical Layer (7ê°œ)</div>
                <ul class="tech-list">
                    <li><span>Canvas í•‘ê±°í”„ë¦°íŒ…</span><span class="badge implemented">12%</span></li>
                    <li><span>WebGL GPU ì •ë³´</span><span class="badge implemented">10%</span></li>
                    <li><span>Audio FRF + THD</span><span class="badge implemented">6%</span></li>
                    <li><span>PRNU ì¹´ë©”ë¼ ë…¸ì´ì¦ˆ</span><span class="badge new">8%</span></li>
                    <li><span>MEMS ì„¼ì„œ ë°”ì´ì–´ìŠ¤</span><span class="badge implemented">6%</span></li>
                    <li><span>Clock Skew</span><span class="badge implemented">4%</span></li>
                    <li><span>Device Orientation</span><span class="badge new">3%</span></li>
                </ul>

                <div class="layer-title">â±ï¸ Temporal Layer (2ê°œ)</div>
                <ul class="tech-list">
                    <li><span>Battery STL</span><span class="badge implemented">5%</span></li>
                    <li><span>Performance Profile</span><span class="badge implemented">6%</span></li>
                </ul>

                <div class="layer-title">ğŸ‘† Behavioral Layer (3ê°œ)</div>
                <ul class="tech-list">
                    <li><span>Touch Pattern</span><span class="badge implemented">4%</span></li>
                    <li><span>Keystroke Dynamics</span><span class="badge implemented">5%</span></li>
                    <li><span>Gait (ë³´í–‰) FFT</span><span class="badge new">4%</span></li>
                </ul>

                <div class="layer-title">ğŸ“± Mobile Layer (6ê°œ)</div>
                <ul class="tech-list">
                    <li><span>Screen + HDR</span><span class="badge new">5%</span></li>
                    <li><span>Speech Synthesis</span><span class="badge new">5%</span></li>
                    <li><span>IP + History</span><span class="badge new">3%</span></li>
                    <li><span>Geolocation + History</span><span class="badge new">4%</span></li>
                    <li><span>Client Hints</span><span class="badge new">4%</span></li>
                    <li><span>Locale/Timezone</span><span class="badge new">2%</span></li>
                </ul>
            </div>

            <!-- í‚¤ìŠ¤íŠ¸ë¡œí¬ -->
            <div class="card">
                <h2>âŒ¨ï¸ í‚¤ìŠ¤íŠ¸ë¡œí¬ ìˆ˜ì§‘</h2>
                <textarea id="typingArea" placeholder="ì•„ë¬´ í…ìŠ¤íŠ¸ë‚˜ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <div id="keystrokeStats" style="margin-top:0.25rem;font-size:0.75rem;color:#8b949e;"></div>

                <div class="warning-box">
                    âš ï¸ <b>ê¶Œí•œ í•„ìš”:</b> PRNU(ì¹´ë©”ë¼), Gait(ëª¨ì…˜ì„¼ì„œ), Geolocation(ìœ„ì¹˜), IP(ë„¤íŠ¸ì›Œí¬)
                </div>
            </div>

            <!-- í•‘ê±°í”„ë¦°íŠ¸ ìƒì„± -->
            <div class="card">
                <h2>ğŸ” í•‘ê±°í”„ë¦°íŠ¸ ìƒì„±</h2>
                <button class="btn" id="requestPermBtn">1. ì„¼ì„œ ê¶Œí•œ ìš”ì²­</button>
                <button class="btn secondary" id="generateBtn" disabled>2. ê¸°ë³¸ í•‘ê±°í”„ë¦°íŠ¸</button>
                <button class="btn orange" id="generateFullBtn" disabled>3. ì „ì²´ ëª¨ë“ˆ (95%)</button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="font-size:0.8rem;">ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (ìµœëŒ€ 5ì´ˆ)</p>
                </div>

                <div class="result" id="resultSection">
                    <div class="accuracy-display">
                        <div class="accuracy-number" id="accuracyValue">0%</div>
                        <div class="accuracy-label">ì˜ˆìƒ ì •í™•ë„</div>
                    </div>
                    <div style="margin-top:0.5rem;">
                        <div class="result-label">í•´ì‹œ</div>
                        <div class="hash-display" id="hashValue">-</div>
                    </div>
                    <div class="result-grid" style="margin-top:0.5rem;">
                        <div class="result-item">
                            <div class="result-label">ì‹ ë¢°ë„</div>
                            <div class="result-value" id="confidenceValue">-</div>
                            <div class="meter">
                                <div class="meter-fill green" id="confidenceMeter" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ì•ˆì •ì„±</div>
                            <div class="result-value" id="stabilityValue">-</div>
                            <div class="meter">
                                <div class="meter-fill orange" id="stabilityMeter" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:0.5rem;">
                        <div class="result-label">í™œì„± ëª¨ë“ˆ</div>
                        <div id="moduleTags"></div>
                    </div>
                </div>
            </div>

            <!-- ìƒì„¸ ê²°ê³¼ -->
            <div class="card" id="detailsCard" style="display:none; grid-column:1/-1;">
                <h2>ğŸ”¬ ìƒì„¸ ë¶„ì„</h2>
                <div class="result-grid" id="detailsGrid"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // ====== Utilities ======
        class FingerprintUtils {
            static async sha256(data) {
                const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(data));
                return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            static mean(samples) {
                if (!samples.length) return [0, 0, 0];
                const sum = samples.reduce((a, c) => [a[0] + (c[0] || 0), a[1] + (c[1] || 0), a[2] + (c[2] || 0)], [0, 0, 0]);
                return sum.map(v => v / samples.length);
            }
            static variance(values) {
                if (!values.length) return 0;
                const m = values.reduce((a, b) => a + b, 0) / values.length;
                return values.reduce((a, b) => a + Math.pow(b - m, 2), 0) / values.length;
            }
        }

        // ====== Behavioral Tracker ======
        class BehavioralTracker {
            constructor() { this.keyTimings = []; this.keyDownTimes = new Map(); this.gaitSamples = []; }
            start() {
                document.addEventListener('keydown', this.onKeyDown);
                document.addEventListener('keyup', this.onKeyUp);
            }
            onKeyDown = e => { if (!this.keyDownTimes.has(e.key)) this.keyDownTimes.set(e.key, performance.now()); };
            onKeyUp = e => {
                const d = this.keyDownTimes.get(e.key);
                if (d) { this.keyTimings.push({ down: d, up: performance.now(), key: e.key }); this.keyDownTimes.delete(e.key); }
            };
            addGait(acc) { this.gaitSamples.push(acc); }
            getKeystroke() {
                const t = this.keyTimings;
                if (t.length < 2) return { avgDwell: 0, avgFlight: 0, rhythm: [], wpm: 0 };
                const dwells = t.map(x => x.up - x.down);
                const flights = [];
                for (let i = 1; i < t.length; i++) flights.push(t[i].down - t[i - 1].up);
                const totalTime = t[t.length - 1].up - t[0].down;
                return {
                    avgDwell: dwells.reduce((a, b) => a + b, 0) / dwells.length,
                    avgFlight: flights.length ? flights.reduce((a, b) => a + b, 0) / flights.length : 0,
                    rhythm: dwells.slice(0, 10),
                    wpm: totalTime > 0 ? (t.length / 5) / (totalTime / 60000) : 0
                };
            }
            getGait() {
                if (this.gaitSamples.length < 50) return null;
                const mags = this.gaitSamples.map(s => Math.sqrt(s[0] ** 2 + s[1] ** 2 + s[2] ** 2));
                return { sampleCount: mags.length, amplitude: Math.max(...mags) - Math.min(...mags) };
            }
        }

        // ====== Fingerprinter ======
        class Fingerprinter {
            constructor() { this.tracker = new BehavioralTracker(); this.tracker.start(); }

            async requestPermissions() {
                if (typeof DeviceMotionEvent?.requestPermission === 'function') {
                    try { return await DeviceMotionEvent.requestPermission() === 'granted'; } catch { return false; }
                }
                return true;
            }

            async generate(options = {}) {
                const modules = [];
                const details = {};

                // Physical Layer
                details.canvas = this.analyzeCanvas();
                modules.push('canvas');

                details.webgl = this.analyzeWebGL();
                if (details.webgl.renderer) modules.push('webgl');

                details.audio = await this.analyzeAudioFRF();
                if (details.audio.hash) modules.push('audio-frf');

                details.mems = await this.analyzeMEMS();
                if (details.mems.sampleCount) modules.push('mems');

                details.clockSkew = await this.measureClockSkew();
                modules.push('clock-skew');

                if (options.enablePRNU) {
                    details.prnu = await this.analyzePRNU();
                    if (details.prnu.hash) modules.push('prnu');
                }

                // Temporal Layer
                details.battery = await this.analyzeBatterySTL();
                if (details.battery.stlSig) modules.push('battery-stl');

                details.perf = await this.measurePerformance();
                modules.push('performance');

                // Behavioral Layer
                details.touch = { support: 'ontouchstart' in window, maxPoints: navigator.maxTouchPoints || 0 };
                if (details.touch.support) modules.push('touch');

                details.keystroke = this.tracker.getKeystroke();
                if (details.keystroke.rhythm.length) modules.push('keystroke');

                if (options.enableGait) {
                    await this.collectGait(3000);
                    details.gait = this.tracker.getGait();
                    if (details.gait) modules.push('gait');
                }

                // Mobile Layer
                details.screen = this.analyzeScreen();
                modules.push('screen');

                details.speech = await this.analyzeSpeech();
                if (details.speech.voiceCount) modules.push('speech');

                details.locale = this.analyzeLocale();
                modules.push('locale');

                details.ip = await this.analyzeIP();
                if (details.ip.publicIP) modules.push('ip');

                if (options.enableGeolocation) {
                    details.geolocation = await this.analyzeGeolocation();
                    if (details.geolocation.latitude) modules.push('geolocation');
                }

                details.clientHints = await this.analyzeClientHints();
                if (details.clientHints.model) modules.push('client-hints');

                // Generate hash
                const hash = await this.generateHash(details, modules);
                const accuracy = this.calcAccuracy(modules);
                const confidence = this.calcConfidence(details);
                const stability = this.calcStability(details);

                return { hash, accuracy, confidence, stability, modules, details };
            }

            async collectGait(duration) {
                return new Promise(resolve => {
                    const handler = e => {
                        if (e.accelerationIncludingGravity) {
                            this.tracker.addGait([e.accelerationIncludingGravity.x || 0, e.accelerationIncludingGravity.y || 0, e.accelerationIncludingGravity.z || 0]);
                        }
                    };
                    window.addEventListener('devicemotion', handler);
                    setTimeout(() => { window.removeEventListener('devicemotion', handler); resolve(); }, duration);
                });
            }

            async analyzeMEMS() {
                return new Promise(resolve => {
                    const acc = [];
                    const h = e => {
                        if (e.accelerationIncludingGravity) acc.push([e.accelerationIncludingGravity.x || 0, e.accelerationIncludingGravity.y || 0, e.accelerationIncludingGravity.z || 0]);
                    };
                    window.addEventListener('devicemotion', h);
                    setTimeout(() => {
                        window.removeEventListener('devicemotion', h);
                        const bias = FingerprintUtils.mean(acc);
                        resolve({ bias, sampleCount: acc.length, quality: Math.min(1, acc.length / 100) });
                    }, 1500);
                });
            }

            async measureClockSkew() {
                const m = [];
                for (let i = 0; i < 100; i++) {
                    const s = performance.now();
                    await new Promise(r => setTimeout(r, 1));
                    m.push(performance.now() - s);
                }
                const mean = m.reduce((a, b) => a + b) / m.length;
                return { skewPPM: (mean - 1) * 1e6, stability: 1 / (1 + FingerprintUtils.variance(m)) };
            }

            analyzeCanvas() {
                const c = document.createElement('canvas'); c.width = 280; c.height = 60;
                const ctx = c.getContext('2d');
                ctx.textBaseline = 'top'; ctx.font = "14px Arial";
                ctx.fillStyle = '#f60'; ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069'; ctx.fillText('FingerprintğŸ˜€ğŸ”’', 2, 15);
                const g = ctx.createLinearGradient(0, 0, 280, 0);
                g.addColorStop(0, 'red'); g.addColorStop(0.5, 'green'); g.addColorStop(1, 'blue');
                ctx.fillStyle = g; ctx.fillRect(0, 40, 280, 20);
                const url = c.toDataURL();
                return { hash: url.slice(-80), entropy: new Set(url).size / 64 };
            }

            analyzeWebGL() {
                const c = document.createElement('canvas');
                const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
                if (!gl) return { vendor: '', renderer: '', hash: '' };
                const d = gl.getExtension('WEBGL_debug_renderer_info');
                const vendor = d ? gl.getParameter(d.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
                const renderer = d ? gl.getParameter(d.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
                return { vendor, renderer, hash: `${vendor}|${renderer}`.slice(0, 100) };
            }

            async analyzeAudioFRF() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const freqResp = [];
                    for (const freq of [100, 500, 1000]) {
                        const osc = ctx.createOscillator();
                        const analyser = ctx.createAnalyser();
                        const gain = ctx.createGain(); gain.gain.value = 0;
                        analyser.fftSize = 2048;
                        osc.frequency.value = freq; osc.type = 'sine';
                        osc.connect(analyser); analyser.connect(gain); gain.connect(ctx.destination);
                        osc.start();
                        await new Promise(r => setTimeout(r, 50));
                        const data = new Float32Array(analyser.frequencyBinCount);
                        analyser.getFloatFrequencyData(data);
                        const bin = Math.round(freq * analyser.fftSize / ctx.sampleRate);
                        freqResp.push(data[bin] || -100);
                        osc.stop();
                    }
                    ctx.close();
                    const hash = await FingerprintUtils.sha256(freqResp.join(','));
                    return { freqResp, hash: hash.slice(0, 24) };
                } catch { return { freqResp: [], hash: '' }; }
            }

            async analyzePRNU() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 160, height: 120 } });
                    const video = document.createElement('video');
                    video.srcObject = stream; await video.play();
                    const canvas = document.createElement('canvas'); canvas.width = 160; canvas.height = 120;
                    const ctx = canvas.getContext('2d');
                    await new Promise(r => setTimeout(r, 200));
                    ctx.drawImage(video, 0, 0);
                    const img = ctx.getImageData(0, 0, 160, 120);
                    stream.getTracks().forEach(t => t.stop());
                    const green = [];
                    for (let i = 1; i < img.data.length; i += 4) green.push(img.data[i]);
                    const hash = await FingerprintUtils.sha256(green.slice(0, 500).join(','));
                    return { hash: hash.slice(0, 24), entropy: FingerprintUtils.variance(green) / 255 };
                } catch { return { hash: '', entropy: 0 }; }
            }

            async analyzeBatterySTL() {
                if (!('getBattery' in navigator)) return { level: 1, stlSig: '' };
                try {
                    const b = await navigator.getBattery();
                    const sig = await FingerprintUtils.sha256(`${b.level}|${b.charging}|${b.chargingTime || 0}`);
                    return { level: b.level, charging: b.charging, stlSig: sig.slice(0, 16) };
                } catch { return { level: 1, stlSig: '' }; }
            }

            async measurePerformance() {
                const s = performance.now();
                let sum = 0; for (let i = 0; i < 1000000; i++) sum += Math.sqrt(i) * Math.sin(i);
                return { score: 1000 / (performance.now() - s), cores: navigator.hardwareConcurrency || 1 };
            }

            analyzeScreen() {
                const s = window.screen;
                return {
                    width: s.width, height: s.height,
                    colorDepth: s.colorDepth,
                    pixelRatio: window.devicePixelRatio || 1,
                    touchPoints: navigator.maxTouchPoints || 0,
                    hdr: window.matchMedia?.('(dynamic-range: high)')?.matches || false
                };
            }

            async analyzeSpeech() {
                return new Promise(resolve => {
                    const getVoices = () => {
                        const voices = speechSynthesis.getVoices();
                        if (voices.length === 0) return;
                        resolve({ voiceCount: voices.length, languages: [...new Set(voices.map(v => v.lang))] });
                    };
                    if (speechSynthesis.getVoices().length > 0) getVoices();
                    else {
                        speechSynthesis.onvoiceschanged = getVoices;
                        setTimeout(() => resolve({ voiceCount: 0, languages: [] }), 1000);
                    }
                });
            }

            analyzeLocale() {
                return {
                    language: navigator.language,
                    languages: [...navigator.languages],
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    offset: new Date().getTimezoneOffset()
                };
            }

            async analyzeIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json', { signal: AbortSignal.timeout(3000) });
                    const data = await response.json();
                    return { publicIP: data.ip || '' };
                } catch { return { publicIP: '' }; }
            }

            async analyzeGeolocation() {
                return new Promise(resolve => {
                    if (!navigator.geolocation) {
                        resolve({ latitude: 0, longitude: 0, accuracy: 0 });
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        pos => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy }),
                        () => resolve({ latitude: 0, longitude: 0, accuracy: 0 }),
                        { timeout: 5000 }
                    );
                });
            }

            async analyzeClientHints() {
                const nav = navigator;
                const uaData = nav.userAgentData;
                if (!uaData) return { platform: navigator.platform || '', model: '' };
                try {
                    const hints = await uaData.getHighEntropyValues(['model', 'platform']);
                    return { platform: hints.platform || '', model: hints.model || '' };
                } catch { return { platform: uaData.platform || '', model: '' }; }
            }

            async generateHash(d, modules) {
                const stable = {
                    canvas: d.canvas?.hash || '',
                    webgl: d.webgl?.hash || '',
                    audio: d.audio?.hash || '',
                    prnu: d.prnu?.hash || '',
                    screen: `${d.screen?.width}x${d.screen?.height}@${d.screen?.pixelRatio}`,
                    speech: d.speech?.voiceCount || 0,
                    locale: d.locale?.timezone || '',
                    cores: d.perf?.cores || 0,
                };
                return FingerprintUtils.sha256(JSON.stringify(stable));
            }

            calcAccuracy(modules) {
                const contrib = {
                    'canvas': 0.12, 'webgl': 0.10, 'audio-frf': 0.06, 'prnu': 0.08, 'orientation': 0.03,
                    'mems': 0.06, 'clock-skew': 0.04, 'battery-stl': 0.05, 'performance': 0.06,
                    'touch': 0.04, 'keystroke': 0.05, 'gait': 0.04,
                    'screen': 0.05, 'speech': 0.05, 'network': 0.02, 'media-devices': 0.03, 'client-hints': 0.04, 'locale': 0.02,
                    'ip': 0.03, 'geolocation': 0.04,
                };
                return Math.min(0.95, 0.08 + modules.reduce((a, m) => a + (contrib[m] || 0), 0));
            }

            calcConfidence(d) {
                let s = 0;
                if (d.canvas?.hash) s += 0.10;
                if (d.webgl?.renderer) s += 0.10;
                if (d.audio?.hash) s += 0.06;
                if (d.prnu?.hash) s += 0.08;
                if (d.mems?.sampleCount > 50) s += 0.06;
                if (d.screen) s += 0.08;
                if (d.speech?.voiceCount) s += 0.06;
                if (d.battery?.stlSig) s += 0.08;
                if (d.perf) s += 0.08;
                if (d.keystroke?.rhythm?.length > 5) s += 0.08;
                if (d.gait) s += 0.06;
                if (d.ip?.publicIP) s += 0.04;
                if (d.geolocation?.latitude) s += 0.06;
                return Math.min(1, s);
            }

            calcStability(d) {
                let s = 0, t = 0;
                if (d.canvas) { s += 2; t += 2; }
                if (d.webgl) { s += 2; t += 2; }
                if (d.screen) { s += 1.5; t += 1.5; }
                if (d.speech) { s += 1.2; t += 1.5; }
                if (d.perf?.cores) { s += 1; t += 1; }
                if (d.locale) { s += 1; t += 1; }
                return t > 0 ? s / t : 0;
            }
        }

        // ====== UI ======
        const fp = new Fingerprinter();
        let permGranted = false;

        document.getElementById('requestPermBtn').onclick = async () => {
            permGranted = await fp.requestPermissions();
            document.getElementById('requestPermBtn').textContent = permGranted ? 'âœ“ ê¶Œí•œ ìŠ¹ì¸ë¨' : 'âœ— ê¶Œí•œ ê±°ë¶€ (ê³„ì† ê°€ëŠ¥)';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateFullBtn').disabled = false;
        };

        document.getElementById('generateBtn').onclick = () => runFingerprint(false);
        document.getElementById('generateFullBtn').onclick = () => runFingerprint(true);

        async function runFingerprint(full) {
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateFullBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('detailsCard').style.display = 'none';

            try {
                const result = await fp.generate({ enablePRNU: full, enableGait: full, enableGeolocation: full });

                document.getElementById('hashValue').textContent = result.hash;
                document.getElementById('accuracyValue').textContent = (result.accuracy * 100).toFixed(0) + '%';
                document.getElementById('confidenceValue').textContent = (result.confidence * 100).toFixed(1) + '%';
                document.getElementById('confidenceMeter').style.width = (result.confidence * 100) + '%';
                document.getElementById('stabilityValue').textContent = (result.stability * 100).toFixed(1) + '%';
                document.getElementById('stabilityMeter').style.width = (result.stability * 100) + '%';

                document.getElementById('moduleTags').innerHTML = result.modules.map(m =>
                    `<span class="module-tag active">${m}</span>`
                ).join('');

                // Details
                const grid = document.getElementById('detailsGrid');
                grid.innerHTML = '';
                const add = (l, v) => { grid.innerHTML += `<div class="result-item"><div class="result-label">${l}</div><div class="result-value">${v}</div></div>`; };

                if (result.details.mems?.sampleCount) add('MEMS ìƒ˜í”Œ', result.details.mems.sampleCount);
                if (result.details.clockSkew) add('í´ë¡ ìŠ¤í', result.details.clockSkew.skewPPM.toFixed(0) + ' ppm');
                if (result.details.audio?.hash) add('Audio FRF', result.details.audio.hash);
                if (result.details.prnu?.hash) add('PRNU', result.details.prnu.hash);
                if (result.details.screen) add('í™”ë©´', `${result.details.screen.width}x${result.details.screen.height}`);
                if (result.details.speech?.voiceCount) add('TTS ìŒì„±', result.details.speech.voiceCount + 'ê°œ');
                if (result.details.battery?.stlSig) add('ë°°í„°ë¦¬ STL', result.details.battery.stlSig);
                if (result.details.perf) add('CPU ì½”ì–´', result.details.perf.cores);
                if (result.details.keystroke?.wpm) add('íƒ€ì´í•‘ WPM', result.details.keystroke.wpm.toFixed(0));
                if (result.details.gait) add('Gait ìƒ˜í”Œ', result.details.gait.sampleCount);
                if (result.details.ip?.publicIP) add('IP', result.details.ip.publicIP);
                if (result.details.geolocation?.latitude) add('ìœ„ì¹˜', `${result.details.geolocation.latitude.toFixed(2)}, ${result.details.geolocation.longitude.toFixed(2)}`);
                if (result.details.locale) add('íƒ€ì„ì¡´', result.details.locale.timezone);
                if (result.details.clientHints?.model) add('ëª¨ë¸', result.details.clientHints.model);

                document.getElementById('detailsCard').style.display = 'block';
                document.getElementById('resultSection').classList.add('active');
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }

            document.getElementById('loading').classList.remove('active');
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateFullBtn').disabled = false;
        }

        // Keystroke stats
        document.getElementById('typingArea').addEventListener('input', () => {
            const k = fp.tracker.getKeystroke();
            if (k.rhythm.length) {
                document.getElementById('keystrokeStats').innerHTML =
                    `<span style="color:#3fb950">Dwell: ${k.avgDwell.toFixed(0)}ms</span> | 
           <span style="color:#58a6ff">Flight: ${k.avgFlight.toFixed(0)}ms</span> | 
           <span style="color:#f0883e">WPM: ${k.wpm.toFixed(0)}</span>`;
            }
        });
    </script>
</body>

</html>